<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="这是一个Java程序员的博客 | Java Blog">
    <meta name="keywords"  content="陆星宏, 陆星宏的博客, Coding Life, 博客, 个人网站, 互联网, Web, Java, Coding, Programing">
    <meta name="theme-color" content="#000000">
    
    <!-- Open Graph -->
    <meta property="og:title" content="MySQL学习笔记(十一)：order by - 陆星宏的博客 | Coding Life">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="order by  的内部实现有两种： 全字段排序 和 rowid排序。
">
    
    <meta property="article:published_time" content="2021-10-25T00:00:00Z">
    
    
    <meta property="article:author" content="">
    
    
    <meta property="article:tag" content="mysql">
    
    
    <meta property="og:image" content="http://localhost:4000/blog/img/me.jpg">
    <meta property="og:url" content="http://localhost:4000/2021/10/25/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%8D%81%E4%B8%80)-order-by/">
    <meta property="og:site_name" content="陆星宏的博客 | Coding Life">
    
    <title>MySQL学习笔记(十一)：order by - 陆星宏的博客 | Coding Life</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/blog/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/blog/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/blog/2021/10/25/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%8D%81%E4%B8%80)-order-by/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/blog/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Mathjax Support -->
   <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        inlineMath: [['$','$']]
        }
    });
   </script>
    <script type="text/javascript" async
       src="https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
    <!--<script src="//cdn.bootcdn.net/ajax/libs/eruda/2.3.3/eruda.js"></script>-->
    <!--<script>eruda.init();</script>-->
    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

<nav class="navbar navbar-default navbar-custom navbar-fixed-top invert">
    
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/blog/">Coding Life</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/blog/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/blog/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/blog/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/blog/img/niuniu.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/blog/img/niuniu.jpg');
        background: ;
    }

    
</style>

<header class="intro-header style-text" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/blog/archive/?tag=mysql" title="mysql">mysql</a>
                        
                    </div>
                    <h1>MySQL学习笔记(十一)：order by</h1>
                    
                    <h2 class="subheading"></h2>
                    <span class="meta">October 25, 2021</span>
                </div>
            </div>
        </div>
    </div>
</header>







<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<p><code class="language-plaintext highlighter-rouge">order by</code>  的内部实现有两种： <strong>全字段排序</strong> 和 <strong>rowid排序</strong>。</p>

<p>按是否需要 <u>磁盘临时文件</u> 辅助排序可分为：<strong>内存排序</strong> 和 <strong>外部排序</strong>。</p>

<p>按是否需要 <u>临时表</u> 辅助排序可分为：<strong>内存临时表</strong> 和 <strong>磁盘临时表</strong>。</p>

<h1 id="查看是否需要排序">查看是否需要排序</h1>

<p>当 <code class="language-plaintext highlighter-rouge">explain</code> 中的 <code class="language-plaintext highlighter-rouge">Extra</code> 字段显示 <code class="language-plaintext highlighter-rouge">Using filesort</code>，表示该查询需要排序。</p>

<p>MySQL 会为每个线程分配一块内存用于排序，称为 <strong><code class="language-plaintext highlighter-rouge">sort_buffer</code></strong>。对应的参数为 <code class="language-plaintext highlighter-rouge">sort_buffer_size</code> ，顾名思义为 <code class="language-plaintext highlighter-rouge">sort_buffer</code> 的大小。默认值为256k，最小可设为32k。</p>

<p><strong>注：只是表示需要排序，这里不区分是在内存还是磁盘，别被 <code class="language-plaintext highlighter-rouge">filesort</code> 误导</strong>。根据数据量和 <code class="language-plaintext highlighter-rouge">sort_buffer</code> 大小，可能是内存排序，也可能是外部排序(需要借助磁盘临时文件辅助排序)。</p>

<hr />

<p><br /><br /><br /></p>

<h1 id="排序实现">排序实现</h1>

<p>可通过 <code class="language-plaintext highlighter-rouge">optimizer_trace</code> 中的 <code class="language-plaintext highlighter-rouge">filesort_summary</code> 中的 <code class="language-plaintext highlighter-rouge">sort_mode</code> 来确定排序采用了哪种实现逻辑。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="o">#</span> <span class="err">只对当前</span><span class="k">session</span><span class="err">生效</span>
<span class="mi">1</span><span class="p">.</span><span class="k">set</span> <span class="n">optimizer_trace</span> <span class="o">=</span> <span class="s1">'enabled=on'</span><span class="p">;</span>
<span class="o">#</span> <span class="err">这两句必须一起执行才能看到</span> <span class="nv">`OPTIMIZER_TRACE`</span> <span class="err">输出，而且只能在命令行中使用，</span><span class="n">datagrip</span><span class="err">中看不到输出</span>
<span class="mi">2</span><span class="p">.</span><span class="err">执行</span><span class="k">sql</span><span class="p">;</span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">`information_schema`</span><span class="p">.</span><span class="nv">`OPTIMIZER_TRACE`</span><span class="err">\</span><span class="k">G</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>截取 <code class="language-plaintext highlighter-rouge">optimizer_trace</code> 部分输出(在末尾部分)如下：</p>

<blockquote>
  <p>为了演示外部排序，将 <code class="language-plaintext highlighter-rouge">sort_buffer_size</code> 设为了最小值 32768(32k)，</p>
</blockquote>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nl">"filesort_summary"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"memory_available"</span><span class="p">:</span><span class="w"> </span><span class="mi">32768</span><span class="p">,</span><span class="w">
              </span><span class="nl">"key_size"</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w">
              </span><span class="nl">"row_size"</span><span class="p">:</span><span class="w"> </span><span class="mi">39</span><span class="p">,</span><span class="w">
              </span><span class="nl">"max_rows_per_buffer"</span><span class="p">:</span><span class="w"> </span><span class="mi">840</span><span class="p">,</span><span class="w">
              </span><span class="nl">"num_rows_estimate"</span><span class="p">:</span><span class="w"> </span><span class="mi">18446744073709551615</span><span class="p">,</span><span class="w">
              </span><span class="nl">"num_rows_found"</span><span class="p">:</span><span class="w"> </span><span class="mi">20211</span><span class="p">,</span><span class="w">
              </span><span class="nl">"num_initial_chunks_spilled_to_disk"</span><span class="p">:</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w">
              </span><span class="nl">"peak_memory_used"</span><span class="p">:</span><span class="w"> </span><span class="mi">35384</span><span class="p">,</span><span class="w">
              </span><span class="nl">"sort_algorithm"</span><span class="p">:</span><span class="w"> </span><span class="s2">"std::sort"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"sort_mode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;fixed_sort_key, packed_additional_fields&gt;"</span><span class="w">
            </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">memory_available</code> 即为排序可使用的内存大小，和上面设置的 <code class="language-plaintext highlighter-rouge">sort_buffer_size</code>一致。</p>

<p><code class="language-plaintext highlighter-rouge">peak_memory_used</code> 表示排序过程中的峰值内存使用大小，可见大于 <code class="language-plaintext highlighter-rouge">sort_buffer_size</code>，内存装不下了，只能使用外部排序，借助磁盘临时文件来辅助排序。</p>

<p><code class="language-plaintext highlighter-rouge">num_initial_chunks_spilled_to_disk</code> 即为排序过程中使用的临时文件数，可见此次排序使用了21个临时文件，使用<strong>归并排序算法</strong>。</p>

<p><code class="language-plaintext highlighter-rouge">num_rows_found</code> 表示有 20211 行数据参与了排序。</p>

<p><strong><code class="language-plaintext highlighter-rouge">sort_mode</code></strong> 总共有3种情况，说明了在 <code class="language-plaintext highlighter-rouge">sort_buffer</code> 中包含了哪些内容：</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">&lt;sort_key, rowid&gt;</code>: This indicates that sort buffer tuples are pairs that contain the sort key value and row ID of the original table row. Tuples are sorted by sort key value and the row ID is used to read the row from the table.</p>

    <blockquote>
      <p>即 <strong>rowid排序</strong>，意思是排序时只使用了排序字段和rowid，目的是为了装入更多数据，尽量使用内存排序。自然，为了获取其他字段内容，还需要根据rowid回表查询。</p>

      <p>对于有主键的Innodb表，<code class="language-plaintext highlighter-rouge">rowid</code> 就是主键；对于没有主键的Innodb表，系统会生成一个6字节的 <code class="language-plaintext highlighter-rouge">rowid</code> 作为主键。</p>

      <p>在 8.0.20 之前，还有一个参数：<strong><code class="language-plaintext highlighter-rouge">max_length_for_sort_data</code></strong>，默认值为4096，用于控制排序的行数据长度。如果单行数据长度超过这个值，MySQL就会由 <code class="language-plaintext highlighter-rouge">全字段排序</code> 转为使用 <code class="language-plaintext highlighter-rouge">rowid排序</code>。</p>

      <p>从 8.0.20 开始，<code class="language-plaintext highlighter-rouge">max_length_for_sort_data</code> 由于优化器的调整已经过时了，设置这个参数将不会有任何作用。</p>

      <p>MySQL的一个设计思想是能用内存就用内存，对于Innodb表来说，会优先选择全字段排序，因为不需要回表(当数据页不在内存中时，回表还是需要读磁盘)，结果集直接就从 <code class="language-plaintext highlighter-rouge">sort_buffer</code> 返回了。<code class="language-plaintext highlighter-rouge">rowid排序</code>是第二选择。如果转成 <code class="language-plaintext highlighter-rouge">rowid</code> 排序内存还放不下的话，最后会转成外部排序。</p>
    </blockquote>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">&lt;sort_key, packed_additional_fields&gt;</code>: Like the previous variant, but the additional columns are packed tightly together instead of using a fixed-length encoding.</p>

    <blockquote>
      <p>即<strong>全字段排序</strong>，<code class="language-plaintext highlighter-rouge">sort_buffer</code> 中包含了排序的字段和查询引用到的全部字段(因此叫做全字段排序)，结果集会直接从 <code class="language-plaintext highlighter-rouge">sort_buffer</code> 中返回。</p>

      <p><code class="language-plaintext highlighter-rouge">packed</code> 表示排序过程由于 <code class="language-plaintext highlighter-rouge">sort_buffer</code> 紧张(见上图)，对字符串做了“紧凑”处理，在排序过程中是按照字段实际长度来分配空间的。</p>
    </blockquote>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">&lt;sort_key, additional_fields&gt;</code>: This indicates that sort buffer tuples contain the sort key value and columns referenced by the query. Tuples are sorted by sort key value and column values are read directly from the tuple.</p>

    <blockquote>
      <p>同上，只是没有了 <code class="language-plaintext highlighter-rouge">packed</code>。</p>

      <p>示例：</p>

      <p>将 <code class="language-plaintext highlighter-rouge">sort_buffer_size</code> 恢复为默认值：262144(256k)，再看看有什么变化：</p>

      <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="nl">"filesort_summary"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"memory_available"</span><span class="p">:</span><span class="w"> </span><span class="mi">262144</span><span class="p">,</span><span class="w">
              </span><span class="nl">"key_size"</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w">
              </span><span class="nl">"row_size"</span><span class="p">:</span><span class="w"> </span><span class="mi">35</span><span class="p">,</span><span class="w">
              </span><span class="nl">"max_rows_per_buffer"</span><span class="p">:</span><span class="w"> </span><span class="mi">1001</span><span class="p">,</span><span class="w">
              </span><span class="nl">"num_rows_estimate"</span><span class="p">:</span><span class="w"> </span><span class="mi">18446744073709551615</span><span class="p">,</span><span class="w">
              </span><span class="nl">"num_rows_found"</span><span class="p">:</span><span class="w"> </span><span class="mi">20211</span><span class="p">,</span><span class="w">
              </span><span class="nl">"num_initial_chunks_spilled_to_disk"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
              </span><span class="nl">"peak_memory_used"</span><span class="p">:</span><span class="w"> </span><span class="mi">43043</span><span class="p">,</span><span class="w">
              </span><span class="nl">"sort_algorithm"</span><span class="p">:</span><span class="w"> </span><span class="s2">"std::stable_sort"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"unpacked_addon_fields"</span><span class="p">:</span><span class="w"> </span><span class="s2">"using_priority_queue"</span><span class="p">,</span><span class="w">
              </span><span class="nl">"sort_mode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;fixed_sort_key, additional_fields&gt;"</span><span class="w">
            </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>      </div>

      <p>可看到 <code class="language-plaintext highlighter-rouge">peak_memory_used</code> &lt; <code class="language-plaintext highlighter-rouge">memory_available</code>，说明 <code class="language-plaintext highlighter-rouge">sort_buffer</code> 完全够用了，直接在内存排序即可，<code class="language-plaintext highlighter-rouge">num_initial_chunks_spilled_to_disk</code> 为0，表示不需要借助磁盘临时文件来辅助排序。</p>

      <p>而且 <code class="language-plaintext highlighter-rouge">sort_mode</code> 中也没有了 <code class="language-plaintext highlighter-rouge">packed</code>，因为内存空间已经完全够用了，不再需要做“紧凑”处理了。</p>
    </blockquote>
  </li>
</ul>

<hr />

<p><br /><br /><br /></p>

<h1 id="排序提速">排序提速</h1>

<p>从上面分析可以看出，排序是个代价比较高的操作，尤其是当转成外部排序时，会涉及到多次磁盘IO。</p>

<p>所以尽量使用内存排序是最优解，对应可调整的参数是 <code class="language-plaintext highlighter-rouge">sort_buffer_size</code>。那还有没有更进一步的优化？</p>

<p><strong>很明显，借助索引，可以完全避免排序</strong>。</p>

<p>比如这样一句sql：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t</span> <span class="k">where</span> <span class="n">city</span> <span class="o">=</span> <span class="s1">'xxx'</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span> <span class="k">limit</span> <span class="mi">1000</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>便可以建立一个 <code class="language-plaintext highlighter-rouge">(city,name)</code>  的联合索引，那么在 <code class="language-plaintext highlighter-rouge">(city,name)</code> 这棵索引树上便是先按 <code class="language-plaintext highlighter-rouge">city</code> 排序，再按<code class="language-plaintext highlighter-rouge">name</code> 排序(即 city 相同时 name 局部有序)。</p>

<p>这样的话只需先快速定位到 city，然后依次往后遍历取出 id，再回表取出整行数据，作为结果集的一部分直接就返回了，完全避免了排序。<u>而且，由于是有序的，对于 limit 来说更友好，不再需要遍历所有 city=xxx 的数据了，遍历到第1000条便可直接结束了</u>(<code class="language-plaintext highlighter-rouge">explain</code> 中的 <code class="language-plaintext highlighter-rouge">rows</code> 不准)。</p>

<p>更进一步，如果查询没必要获取全部字段，则可利用到<strong>覆盖索引</strong>，直接从索引树获取到全部字段，连回表查询都不用了。</p>

<p>如上面的 sql 可改为：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="n">city</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">age</span> <span class="k">from</span> <span class="n">t</span> <span class="k">where</span> <span class="n">city</span> <span class="o">=</span> <span class="s1">'xxx'</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span> <span class="k">limit</span> <span class="mi">1000</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>此时建一个 <code class="language-plaintext highlighter-rouge">(city,name,age)</code> 的联合索引，即可满足排序需求，又不需要回表查询，此时是最优解。</p>

<p>当然，还是那句老话，维护索引有代价，需综合考虑。</p>

<hr />

<p><br /><br /><br /></p>

<h1 id="实例">实例</h1>

<p>假设维护一个人员信息表，现已有索引 <code class="language-plaintext highlighter-rouge">(city,name)</code> ，问以下查询是否需要排序？</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t</span> <span class="k">where</span> <span class="n">city</span> <span class="k">in</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span> <span class="k">limit</span> <span class="mi">100</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>虽然已有 <code class="language-plaintext highlighter-rouge">(city,name)</code> 索引，但只能保证同一 city 内 name 有序，不同 city 之间 name 仍然是无序的。所以该查询在数据库内部仍然需要排序。</p>

<p>如果出于种种原因想要避免在数据库内部排序，有什么办法？</p>

<p>那就在应用端排序，把一条sql拆为两句：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t</span> <span class="k">where</span> <span class="n">city</span> <span class="o">=</span> <span class="n">A</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span> <span class="k">limit</span> <span class="mi">100</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t</span> <span class="k">where</span> <span class="n">city</span> <span class="o">=</span> <span class="n">B</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span> <span class="k">limit</span> <span class="mi">100</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>拆开的查询可以利用到索引，不需要排序</strong>。</p>

<p>在应用端便可得到两个有序数组，使用归并排序合并为一个有序数组后，取前100即为结果集。</p>

<p>如果是分页查询呢，比如：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t</span> <span class="k">where</span> <span class="n">city</span> <span class="k">in</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">)</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span> <span class="k">limit</span> <span class="mi">10000</span><span class="p">,</span><span class="mi">100</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>还是和上面的思路一样，拆分为2个查询：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t</span> <span class="k">where</span> <span class="n">city</span> <span class="o">=</span> <span class="n">A</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span> <span class="k">limit</span> <span class="mi">10100</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t</span> <span class="k">where</span> <span class="n">city</span> <span class="o">=</span> <span class="n">B</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span> <span class="k">limit</span> <span class="mi">10100</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>同样使用归并算法得到一个有序数组，取第 10000 ~ 10100 的值即为结果集。</p>

<p>这时的问题是数据量太大，如果应用端内存紧张的话，可考虑只查询 id 和 name：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="n">id</span><span class="p">,</span><span class="n">name</span> <span class="k">from</span> <span class="n">t</span> <span class="k">where</span> <span class="n">city</span> <span class="o">=</span> <span class="n">A</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span> <span class="k">limit</span> <span class="mi">10100</span><span class="p">;</span>
<span class="k">select</span> <span class="n">id</span><span class="p">,</span><span class="n">name</span> <span class="k">from</span> <span class="n">t</span> <span class="k">where</span> <span class="n">city</span> <span class="o">=</span> <span class="n">B</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span> <span class="k">limit</span> <span class="mi">10100</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>该查询不需排序，且会用到覆盖索引，也不用回表。合并得到有序数组后，取出第 10000 ~ 10100 的 id，再拿这100个 id 去数据库查出所有记录即可。</p>

<hr />

<p><br /> <br /> <br /></p>

<h1 id="随机排序">随机排序</h1>

<p>随机排序在现实中的应用场景还是比较多的，可能会首先想到使用<code class="language-plaintext highlighter-rouge">order by rand()</code> 。</p>

<p>比如：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">words</span> <span class="k">order</span> <span class="k">by</span> <span class="n">rand</span><span class="p">()</span> <span class="k">limit</span> <span class="mi">3</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>表示从单词表中随机抽取3个单词。</p>

<p>虽然用法简单明了，但它的执行效率怎样(对于数据量不是特别大的表，其实也完全够用了)，做个实验。</p>

<p>先构造一张 <code class="language-plaintext highlighter-rouge">words</code> 表和实验数据：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`words`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="nv">`word`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="p">;</span>

<span class="k">delimiter</span> <span class="p">;;</span>
<span class="k">create</span> <span class="k">procedure</span> <span class="n">idata</span><span class="p">()</span>
<span class="k">begin</span>
  <span class="k">declare</span> <span class="n">i</span> <span class="nb">int</span><span class="p">;</span>
  <span class="k">set</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
  <span class="n">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10000</span> <span class="k">do</span>
    <span class="k">insert</span> <span class="k">into</span> <span class="n">words</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">values</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="nb">char</span><span class="p">(</span><span class="mi">97</span><span class="o">+</span><span class="p">(</span><span class="n">i</span> <span class="n">div</span> <span class="mi">1000</span><span class="p">)),</span> <span class="nb">char</span><span class="p">(</span><span class="mi">97</span><span class="o">+</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="n">div</span> <span class="mi">100</span><span class="p">)),</span> <span class="nb">char</span><span class="p">(</span><span class="mi">97</span><span class="o">+</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="n">div</span> <span class="mi">10</span><span class="p">)),</span> <span class="nb">char</span><span class="p">(</span><span class="mi">97</span><span class="o">+</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span><span class="p">))));</span>
    <span class="k">set</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">end</span> <span class="n">while</span><span class="p">;</span>
<span class="k">end</span><span class="p">;;</span>
<span class="k">delimiter</span> <span class="p">;</span>

<span class="k">call</span> <span class="n">idata</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">explain</code> 下看看：</p>

<p><img src="/home/head/.config/Typora/typora-user-images/image-20211206121345480.png" alt="image-20211206121345480" /></p>

<p><code class="language-plaintext highlighter-rouge">Extra</code> 显示 <code class="language-plaintext highlighter-rouge">Using temporary; Using filesort</code> ，表示需要临时表，需要排序。</p>

<blockquote>
  <p>注：需要和上面讲到的临时文件区分开来，临时表和临时文件是两个东西。</p>
</blockquote>

<p>为什么需要临时表?</p>

<p><code class="language-plaintext highlighter-rouge">order by rand()</code> 的实现逻辑是为每一行数据生成一个随机数，然后按这个随机数来排序，以达到随机排序的目的。所以需要一张临时表来存放这个新生成的随机数字段。</p>

<p>再次强调，<code class="language-plaintext highlighter-rouge">Using filesort</code> 只是表示需要排序，有可能是内存排序，也有可能是外部排序。不要看它的名字是 <code class="language-plaintext highlighter-rouge">filesort</code>，就认为一定是外部排序。</p>

<p>它的整个流程是这样的：</p>

<ol>
  <li>生成一张内存临时表。扫描 <code class="language-plaintext highlighter-rouge">words</code> 表，将 <code class="language-plaintext highlighter-rouge">word</code> 字段和生成的随机数存入临时表；</li>
  <li>将 <code class="language-plaintext highlighter-rouge">word</code> 字段和随机数放入 <code class="language-plaintext highlighter-rouge">sort_buffer</code> 排序；</li>
  <li>从 <code class="language-plaintext highlighter-rouge">sort_buffer</code> 中取出前3个 <code class="language-plaintext highlighter-rouge">word</code>，作为结果集返回。</li>
</ol>

<p>可通过 <code class="language-plaintext highlighter-rouge">optimizer_trace</code> 验证一下：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">set</span> <span class="n">optimizer_trace</span><span class="o">=</span><span class="s1">'enabled=on'</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">words</span> <span class="k">order</span> <span class="k">by</span> <span class="n">rand</span><span class="p">()</span> <span class="k">limit</span> <span class="mi">3</span><span class="p">;</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">OPTIMIZER_TRACE</span><span class="err">\</span><span class="k">G</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/home/head/.config/Typora/typora-user-images/image-20211206130948945.png" alt="image-20211206130948945" /></p>

<p>可看到该排序使用了全字段排序，且没有使用到磁盘临时文件。<code class="language-plaintext highlighter-rouge">sort_buffer</code> 中同时最多有4行数据存在，每一行长度为 $8+279=287$。为什么只有4行？难道不应该是对10000行数据排序吗？</p>

<p>答案是<code class="language-plaintext highlighter-rouge">filesort_priority_queue_optimization</code>中 <code class="language-plaintext highlighter-rouge">chosen</code> 为 <code class="language-plaintext highlighter-rouge">true</code>，表示使用了优先级队列排序(即堆排序)。因为只需要 <code class="language-plaintext highlighter-rouge">limit 3</code>，相当于求 <code class="language-plaintext highlighter-rouge">top3</code>，剩下9997条数据并不需要排序，堆排序完美适合解决这个问题。</p>

<blockquote>
  <p><strong>大顶堆求 top k 小，小顶堆求 top k 大</strong>。而且最后堆顶元素就是第k大(小)元素。</p>

  <p>比如数据集为[0.9,0.4,0.5,0.7,0.3,0.8]，利用大顶堆求top3小：</p>

  <ol>
    <li>建立初始堆：[0.9,0.4,0.5]，0.9为堆顶元素；</li>
    <li>插入0.7，比0.9小，交换，0.7为最大元素，堆无需调整，此时堆为 [0.7,0.4,0.5]；</li>
    <li>插入0.3，比0.7小，交换，0.3下沉堆化，此时堆为 [0.5,0.4,0.3]；</li>
    <li>插入0.8，比0.5大，无需交换，堆不变，此时堆为 [0.5,0.4,0.3]；</li>
    <li>遍历结束，top3小即为 [0.5,0.4,0.3]，且0.5为第3小的元素。</li>
  </ol>
</blockquote>

<h3 id="随机排序方法">随机排序方法</h3>

<h4 id="方法一">方法一</h4>

<p>随机取一行的算法如下：</p>

<ol>
  <li>取得主键 id 的最大值M和最小值N</li>
  <li>用随机函数生成一个介于M和N之间的数 $X=(M-N)*rand()+N$</li>
  <li>取 $≥X$ 的第一个 id 的行</li>
</ol>

<p>用sql表示如下：</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="k">min</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">into</span> <span class="o">@</span><span class="n">M</span><span class="p">,</span><span class="o">@</span><span class="n">N</span> <span class="k">from</span> <span class="n">t</span><span class="p">;</span>
<span class="k">set</span> <span class="o">@</span><span class="n">X</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="o">@</span><span class="n">M</span><span class="o">-@</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="n">rand</span><span class="p">()</span><span class="o">+@</span><span class="n">N</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t</span> <span class="k">where</span> <span class="n">id</span> <span class="o">&gt;=</span> <span class="o">@</span><span class="n">x</span> <span class="k">limit</span> <span class="mi">1</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">max(id)</code> 和 <code class="language-plaintext highlighter-rouge">min(id)</code> 都不需要扫描索引，第三步的 <code class="language-plaintext highlighter-rouge">select</code> 也可以用索引快速定位，速度很快。</p>

<p>但是有个致命缺陷，它<strong>不是真正的随机。如果 id 是连续的没问题，但如果 id 之间有空洞，则选择不同行的概率不一样</strong>。</p>

<p>如 [1,2,4,5]，按这个算法，4 被选中的概率是其他的两倍。<strong>但是它速度最快</strong>。</p>

<h4 id="方法二">方法二</h4>

<ol>
  <li>取得整个表的行数，记做 C</li>
  <li>$Y = floor(C*rand())$</li>
  <li>limit Y,1</li>
</ol>

<p><code class="language-plaintext highlighter-rouge">limit Y,1</code> 的处理逻辑是按顺序一行行读出来，丢掉前Y个，取下一个作为结果返回(可通过慢查询日志的 <code class="language-plaintext highlighter-rouge">Rows_examined</code> 验证)。</p>

<blockquote>
  <p>这里可能会有点疑问，为什么不走主键索引树，直接快速定位到 Y不就行了。</p>

  <p>这是想当然了，因为并不知道第 Y 行的主键id是多少呀，除非只有当主键id从1开始连续递增才行(第Y行的主键id就是Y)。</p>
</blockquote>

<p>所以该算法总共扫描的行数为：$C+Y+1$ ，执行代价比方法一要高一些，但跟 <code class="language-plaintext highlighter-rouge">order by rand()</code> 比起来还是快得多，而且严格随机。</p>

<p>那么用该算法解决随机获取3个单词的步骤如下：</p>

<ol>
  <li>取得整个表的行数，记做 C</li>
  <li>$Y1 = floor(C<em>rand()), Y2 = floor(C</em>rand()), Y3 = floor(C*rand())$</li>
  <li>limit Y1,1；limit Y2,1；limit Y3,1</li>
</ol>

<p>总共需扫描  $【C+(Y1+Y2+Y3)+3】$ 行 。</p>

<p>其实还有进一步优化的空间，因为Y1、Y2、Y3 重复扫描了：</p>

<p>取得 Y1、Y2、Y3后，设最大值为M，最小值为N，执行</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t</span> <span class="k">limit</span> <span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="o">-</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>从结果集中取第一条、最后一条、(Y2-Y1)条即可。</p>

<p>改进后扫描行数为 $C+M+1$，大大减少了扫描行数。</p>

<p><strong>不可一味盲目追求极致解，够用就好！！！</strong></p>

<hr />

<p><br /><br /><br /></p>

<h1 id="官方优化指南">官方优化指南</h1>

<p><a href="https://dev.mysql.com/doc/refman/8.0/en/order-by-optimization.html">ORDER BY Optimization</a></p>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/blog/2021/10/22/MySQL%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0(%E5%8D%81)-count/" data-toggle="tooltip" data-placement="top" title="MySQL学习笔记(十)：count">
                        Previous<br>
                        <span>MySQL学习笔记(十)：count</span>
                        </a>
                    </li>
                    
                    
                </ul>
                <hr style="visibility: hidden;">

                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/blog/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0014" 
                    href="/blog/archive/?tag=Manjaro"
                    title="Manjaro"
                    rel="1">Manjaro</a>
        
                <a data-sort="0004" 
                    href="/blog/archive/?tag=mysql"
                    title="mysql"
                    rel="11">mysql</a>
        
                <a data-sort="0014" 
                    href="/blog/archive/?tag=%E4%BA%8B%E5%8A%A1"
                    title="事务"
                    rel="1">事务</a>
        
                <a data-sort="0014" 
                    href="/blog/archive/?tag=%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"
                    title="数据类型"
                    rel="1">数据类型</a>
        
                <a data-sort="0014" 
                    href="/blog/archive/?tag=%E6%B5%AE%E7%82%B9%E6%95%B0"
                    title="浮点数"
                    rel="1">浮点数</a>
        
                <a data-sort="0014" 
                    href="/blog/archive/?tag=%E7%B4%A2%E5%BC%95"
                    title="索引"
                    rel="1">索引</a>
        
                <a data-sort="0014" 
                    href="/blog/archive/?tag=%E9%94%81"
                    title="锁"
                    rel="1">锁</a>
        
                <a data-sort="0014" 
                    href="/blog/archive/?tag=Git"
                    title="Git"
                    rel="1">Git</a>
        
                <a data-sort="0014" 
                    href="/blog/archive/?tag=binlog"
                    title="binlog"
                    rel="1">binlog</a>
        
                <a data-sort="0014" 
                    href="/blog/archive/?tag=redo"
                    title="redo"
                    rel="1">redo</a>
        
                <a data-sort="0014" 
                    href="/blog/archive/?tag=springboot"
                    title="springboot"
                    rel="1">springboot</a>
        
                <a data-sort="0014" 
                    href="/blog/archive/?tag=starter"
                    title="starter"
                    rel="1">starter</a>
    </div>
</section>


                <!-- Friends Blog -->
                <!--
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
</ul>
-->
            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  
  
  
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Coding Life 2021
                    <br>
                    模板来自 <a href="https://github.com/Huxpro/huxpro.github.io">huxpro.github.io</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/blog/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/blog/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/blog/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/blog/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/blog/js/snackbar.js "></script>
<script src="/blog/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-49627206-1';
    var _gaDomain = 'huangxuan.me';

    // Originial
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
            m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/blog/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/blog/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        // templateMiddleware: function (prop, value, template) {
        //     if (prop === 'subtitle' || prop === 'title') {
        //         if (value.indexOf("code")) {
        //             return htmlDecode(value);
        //         } else {
        //             return value;
        //         }
        //     }
        // }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>



<!-- Image to hack wechat -->
<img src="/blog/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
